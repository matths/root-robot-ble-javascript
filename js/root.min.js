var crc8=function(){var s={CRC8:213,CRC8_CCITT:7,CRC8_DALLAS_MAXIM:49,CRC8_SAE_J1850:29,CRC_8_WCDMA:155,CRC_C2_Baicheva98:151};return function(t,e){for(var i=function(t){t=t||s.CRC8;for(var e=[],i=0;i<256;++i){for(var o=i,n=0;n<8;++n)o=0!=(128&o)?(o<<1^t)%256:(o<<1)%256;e[i]=o}return e}(s.CRC8_CCITT),o=0,n=0;n<t.length;n++)o=i[(o^t[n])%256];return e?o:"0x"+("00"+o.toString(16)).substr(-2)}}();function EventDispatcher(){}function BleDevice(t,e){this.init(t,e)}function RootDeviceGeneral(t){this.init(t)}function RootDeviceMotors(t){this.init(t)}function RootDeviceMarkerEraser(t){this.init(t)}function RootDeviceLedLights(t){this.init(t)}function RootDeviceLedColorSensor(t){this.init(t)}function RootDeviceSound(t){this.init(t)}function RootDeviceBumpers(t){this.init(t)}function RootDeviceLightSensors(t){this.init(t)}function RootDeviceBattery(t){this.init(t)}function RootDeviceTouchSensors(t){this.init(t)}function RootDeviceCliffSensor(t){this.init(t)}Object.assign(EventDispatcher.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0!==this._listeners){var i=this._listeners[t];if(void 0!==i){var o=i.indexOf(e);-1!==o&&i.splice(o,1)}}},dispatchEvent:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),o=0,n=i.length;o<n;o++)i[o].call(this,t)}}}}),Object.assign(BleDevice.prototype,{init:function(t,e){this.device=null,this.server=null,this.scanOptions={acceptAllDevices:!1,filters:[{services:[t]}],optionalServices:e}},log:function(){window.LOG&&console.log.apply(console,arguments)},scanAndConnect:function(){var e=this;navigator.bluetooth.requestDevice(this.scanOptions).then(function(t){e.device=t,e.device.addEventListener("gattserverdisconnected",e.disconnectedBleDeviceHandler.bind(e)),e.log("BLE device selected",e.device),e.connectBleDevice()}).catch(function(t){e.log("BLE device not selected",t)})},connectBleDevice:function(){var e=this;this.device.gatt.connect().then(function(t){e.server=t,e.log("BLE device connected"),e.dispatchEvent({type:"connected"})}).catch(function(t){e.log("BLE device not connected",t)})},disconnect:function(){this.device&&this.device.gatt.connected&&(this.device.gatt.disconnect(),this.device=null)},disconnectedBleDeviceHandler:function(){this.log("BLE device disconnected"),this.dispatchEvent({type:"disconnected"})},getCharacteristicByServiceUuidAndCharacteristicUuid:function(t,e,i){var o=this;this.server.getPrimaryService(t).then(function(t){return t.getCharacteristic(e)}).then(function(t){i(t)}).catch(function(t){o.log("error",t)})},readValueFromCharacteristic:function(t,e){var i=this;t.readValue().then(function(t){e(t)}).catch(function(t){i.log("error",t)})},writeValueFromCharacteristic:function(t,e){t.writeValue(e)},listenForNotificationValueFromCharacteristic:function(t,e){t.addEventListener("characteristicvaluechanged",function(t){e(t)}),t.startNotifications()}}),Object.assign(BleDevice.prototype,EventDispatcher.prototype),Object.assign(RootDeviceGeneral.prototype,{init:function(t){this.root=t,this.device=0,this.BOARD_MAIN=165,this.BOARD_COLOR=198,this.root.listenForRobotEvent(this.device,4,this.stopProject.bind(this))},getVersions:function(t,e){this.root.toRobot(this.device,0,[t],this.getVersionsResponse(e))},getVersionsResponse:function(o){return function(t){var e=t.getUint8(0),i="Board: "+(165==e?"Main board":198==e?"Color board":"N/A");i+="\nFirmware version: "+t.getUint8(1)+"."+t.getUint8(2),i+="\nHardware version: "+t.getUint8(3)+"."+t.getUint8(4),i+="\nBootloader version: "+t.getUint8(5)+"."+t.getUint8(6),i+="\nProtocol version: "+t.getUint8(7)+"."+t.getUint8(8),o(i)}},setName:function(t){var e=this.root.encodeUtf8Text(t);this.root.toRobot(this.device,1,e)},getName:function(t){this.root.toRobot(this.device,2,null,this.getNameResponse(t))},getNameResponse:function(e){return function(t){e(this.root.decodeUtf8Text(t))}},stopAndReset:function(){this.root.toRobot(this.device,3)},stopProject:function(t){this.dispatchEvent({type:"stopProject"})},disconnect:function(){this.root.toRobot(this.device,6,null)},enableEvents:function(t){this.root.toRobot(this.device,7,null)},disableEvents:function(t){this.root.toRobot(this.device,9,t)},getEnabledEvents:function(t){this.root.toRobot(this.device,11,null,this.getEnabledEventsResponse(t))},getEnabledEventsResponse:function(e){return function(t){e(t)}},getSerialNumber:function(t){this.root.toRobot(this.device,14,null,this.getSerialNumberResponse(t))},getSerialNumberResponse:function(i){return function(t){var e=this.root.decodeUtf8Text(t.buffer.slice(0,12));i(e)}}}),Object.assign(RootDeviceGeneral.prototype,EventDispatcher.prototype),Object.assign(RootDeviceMotors.prototype,{init:function(t){this.root=t,this.device=1,this.STALL_MOTOR_LEFT=0,this.STALL_MOTOR_RIGHT=1,this.STALL_MOTOR_MARKER_ERASER=2,this.STALL_CAUSE_NO_STALL=0,this.STALL_CAUSE_OVERCURRENT=1,this.STALL_CAUSE_UNDERCURRENT=2,this.STALL_CAUSE_UNDERSPEED=3,this.STALL_CAUSE_SATURATED_PID=4,this.STALL_CAUSE_TIMEOUT=5,this.BOARD_COLOR=198,this.root.listenForRobotEvent(this.device,29,this.motorStall.bind(this))},setLeftAndRightMotorSpeed:function(t,e){var i=new DataView(new Uint8Array(8).buffer);i.setInt32(0,t,!1),i.setInt32(4,e,!1);var o=new Uint8Array(i.buffer);this.root.toRobot(this.device,4,o)},setLeftMotorSpeed:function(t){var e=new DataView(new Uint8Array(4).buffer);e.setInt32(0,t,!1);var i=new Uint8Array(e.buffer);this.root.toRobot(this.device,6,i)},setRightMotorSpeed:function(t){var e=new DataView(new Uint8Array(4).buffer);e.setInt32(0,t,!1);var i=new Uint8Array(e.buffer);this.root.toRobot(this.device,7,i)},driveDistance:function(t,e){var i=new DataView(new Uint8Array(4).buffer);i.setInt32(0,t,!1);var o=new Uint8Array(i.buffer);this.root.toRobot(this.device,8,o,this.driveDistanceFinishedResponse(e),null)},driveDistanceFinishedResponse:function(t){return t},rotateAngel:function(t,e){var i=new DataView(new Uint8Array(4).buffer);i.setInt32(0,t,!1);var o=new Uint8Array(i.buffer);this.root.toRobot(this.device,12,o,this.rotateAngelFinishedResponse(e),null)},rotateAngelFinishedResponse:function(t){return t},motorStall:function(t){t.getUint32(0);var e=t.getUint8(4),i=t.getUint8(5);this.dispatchEvent({type:"motorStall",motor:e,cause:i})}}),Object.assign(RootDeviceMotors.prototype,EventDispatcher.prototype),Object.assign(RootDeviceMarkerEraser.prototype,{init:function(t){this.root=t,this.device=2,this.MARKER_UP_ERASER_UP=0,this.MARKER_DOWN_ERASER_UP=1,this.MARKER_UP_ERASER_DOWN=2},setMarkerEraserPosition:function(t,e){var i=new Uint8Array([t]);this.root.toRobot(this.device,0,i,this.setMarkerEraserPositionFinishedResponse(e),3e3)},setMarkerEraserPositionFinishedResponse:function(i){return function(t){var e=t.getUint8(0);i(e)}}}),Object.assign(RootDeviceMarkerEraser.prototype,EventDispatcher.prototype),Object.assign(RootDeviceLedLights.prototype,{init:function(t){this.root=t,this.device=3,this.LED_STATE_OFF=0,this.LED_STATE_ON=1,this.LED_STATE_BLINK=2,this.LED_STATE_SPIN=3},setLedAnimation:function(t,e,i,o){var n=new Uint8Array([t,e,gree,o]);this.root.toRobot(this.device,0,n)}}),Object.assign(RootDeviceLedLights.prototype,EventDispatcher.prototype),Object.assign(RootDeviceLedColorSensor.prototype,{init:function(t){this.root=t,this.device=4,this.BANK_0_7=0,this.BANK_8_15=1,this.BANK_16_23=2,this.BANK_24_31=3,this.LIGHTING_OFF=0,this.LIGHTING_RED=1,this.LIGHTING_GREEN=2,this.LIGHTING_BLUE=3,this.LIGHTING_ALL=4,this.FORMAT_12_BIT_ADC_COUNTS=0,this.FORMAT_MILLIVOLTS=1,this.COLOR_WHITE=0,this.COLOR_BLACK=1,this.COLOR_RED=2,this.COLOR_GREEN=3,this.COLOR_BLUE=4,this.root.listenForRobotEvent(this.device,2,this.colorSensorEvent.bind(this))},getColorSensorData:function(t,e,i,o){var n=new Uint8Array([t,e,i]);this.root.toRobot(this.device,1,n,this.colorSensorDataResponse(o))},colorSensorDataResponse:function(i){return function(t){var e=new Uint16Array(t.buffer);i(e)}},colorSensorEvent:function(t){var e=this.root.getUint4Array(t);this.dispatchEvent({type:"colorSensor",colorValues:e})}}),Object.assign(RootDeviceLedColorSensor.prototype,EventDispatcher.prototype),Object.assign(RootDeviceSound.prototype,{init:function(t){this.root=t,this.device=5,this.FREQUENCY_NOTE_C=261.63,this.FREQUENCY_NOTE_D=293.66,this.FREQUENCY_NOTE_E=329.62,this.FREQUENCY_NOTE_F=349.23,this.FREQUENCY_NOTE_G=392,this.FREQUENCY_NOTE_A=440,this.FREQUENCY_NOTE_H=466.16,this.FREQUENCY_NOTE_C=493.88,this.DURATION_FULL=2,this.DURATION_HALF=1,this.DURATION_QUARTER=.5,this.DURATION_EIGHTH=.25,this.DURATION_SIXTEENTHS=.125},playNote:function(t,e,i){var o=new DataView(new Uint8Array(6).buffer);o.setUint32(0,t),o.setUint16(4,e);var n=new Uint8Array(o.buffer);this.root.toRobot(this.device,0,n,this.playNoteFinishedResponse(i))},playNoteFinishedResponse:function(t){return t},stopNote:function(){this.root.toRobot(this.device,1)},sayPhrase:function(t,e){var i=this.root.encodeUtf8Text(t);this.root.toRobot(this.device,4,i,this.sayPhraseFinishedResponse(e))},sayPhraseFinishedResponse:function(t){return t}}),Object.assign(RootDeviceSound.prototype,EventDispatcher.prototype),Object.assign(RootDeviceBumpers.prototype,{init:function(t){this.root=t,this.device=12,this.NO_BUMPERS_PRESSED=0,this.RIGHT_BUMPER_PRESSED=64,this.LEFT_BUMPER_PRESSED=128,this.BOTH_BUMPERS_PRESSED=192,this.root.listenForRobotEvent(this.device,0,this.bumper.bind(this))},bumper:function(t){t.getUint32(0);var e=t.getUint8(4);this.dispatchEvent({type:"bumper",state:e})}}),Object.assign(RootDeviceBumpers.prototype,EventDispatcher.prototype),Object.assign(RootDeviceLightSensors.prototype,{init:function(t){this.root=t,this.device=13,this.AMBIENT_LIGHT_BOTH_EYES_DARK=4,this.AMBIENT_LIGHT_RIGHT_EYE_BRIGHTER_THAN_LEFT_EYE=5,this.AMBIENT_LIGHT_LEFT_EYE_BRIGHTER_THAN_RIGHT_EYE=6,this.AMBIENT_LIGHT_BOTH_EYES_BRIGHT=7,this.root.listenForRobotEvent(this.device,0,this.light.bind(this))},light:function(t){t.getUint32(0);var e=t.getUint8(4),i=t.getUint16(5),o=t.getUint16(7);this.dispatchEvent({type:"light",state:e,left:i,right:o})}}),Object.assign(RootDeviceLightSensors.prototype,EventDispatcher.prototype),Object.assign(RootDeviceBattery.prototype,{init:function(t){this.root=t,this.device=14,this.root.listenForRobotEvent(this.device,0,this.batteryLevel.bind(this))},getBatteryLevel:function(t,e,i){this.root.toRobot(this.device,1,null,this.getBatteryLevelResponse(i))},getBatteryLevelResponse:function(n){return function(t){var e=t.getUint32(0),i=t.getUint16(4),o=t.getUint8(6);n(e,i,o)}},batteryLevel:function(t){var e=t.getUint32(0),i=t.getUint16(4),o=t.getUint8(6);this.dispatchEvent({type:"light",timestamp:e,voltage:i,percent:o})}}),Object.assign(RootDeviceBattery.prototype,EventDispatcher.prototype),Object.assign(RootDeviceTouchSensors.prototype,{init:function(t){this.root=t,this.device=17,this.TOUCH_FRONT_LEFT=128,this.TOUCH_FRONT_RIGHT=64,this.TOUCH_REAR_RIGHT=32,this.TOUCH_REAR_LEFT=16,this.root.listenForRobotEvent(this.device,0,this.touch.bind(this))},touch:function(t){t.getUint32(0);var e=t.getUint8(4);this.dispatchEvent({type:"touch",frontLeft:!!(e&this.TOUCH_FRONT_LEFT),frontRight:!!(e&this.TOUCH_FRONT_RIGHT),rearRight:!!(e&this.TOUCH_REAR_RIGHT),rearLeft:!!(e&this.TOUCH_REAR_LEFT),state:e})}}),Object.assign(RootDeviceTouchSensors.prototype,EventDispatcher.prototype),Object.assign(RootDeviceCliffSensor.prototype,{init:function(t){this.root=t,this.device=20,this.root.listenForRobotEvent(this.device,0,this.cliff.bind(this))},cliff:function(t){t.getUint32(0);var e=t.getUint8(4),i=t.getUint16(5),o=t.getUint16(7);this.dispatchEvent({type:"cliff",cliff:e,sensor:i,threshold:o})}}),Object.assign(RootDeviceCliffSensor.prototype,EventDispatcher.prototype);var bleProfile={root:{service:{RootIdentifier:{UUID:"48c5d828-ac2a-442d-97a3-0c9822b04979",characteristic:{}},DeviceInformation:{UUID:"0000180a-0000-1000-8000-00805f9b34fb",characteristic:{SerialNumber:{UUID:"00002a25-0000-1000-8000-00805f9b34fb"},FirmwareVersion:{UUID:"00002a26-0000-1000-8000-00805f9b34fb"},"Hardware Version":{UUID:"00002a27-0000-1000-8000-00805f9b34fb"},Manufacturer:{UUID:"00002a29-0000-1000-8000-00805f9b34fb"},"Robot State":{UUID:"00008bb6-0000-1000-8000-00805f9b34fb"}}},UART:{UUID:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",characteristic:{TX:{UUID:"6e400002-b5a3-f393-e0a9-e50e24dcca9e"},RX:{UUID:"6e400003-b5a3-f393-e0a9-e50e24dcca9e"}}}}}};function Root(t){this.init(t)}Object.assign(Root.prototype,{init:function(t){this.utf8TextEncoder=new TextEncoder("utf-8"),this.utf8TextDecoder=new TextDecoder("utf-8"),this.bleDevice=t,this.pending={},this.inc=0,this.rx=null,this.tx=null,this.device={},this.device.general=new RootDeviceGeneral(this),this.device.motors=new RootDeviceMotors(this),this.device.markerEraser=new RootDeviceMarkerEraser(this),this.device.ledLights=new RootDeviceLedLights(this),this.device.colorSensor=new RootDeviceLedColorSensor(this),this.device.sound=new RootDeviceSound(this),this.device.bumpers=new RootDeviceBumpers(this),this.device.lightSensors=new RootDeviceLightSensors(this),this.device.battery=new RootDeviceBattery(this),this.device.touchSensors=new RootDeviceTouchSensors(this),this.device.cliffSensor=new RootDeviceCliffSensor(this)},log:function(){window.LOG&&console.log.apply(console,arguments)},setup:function(e){var i=this;this.bleDevice.getCharacteristicByServiceUuidAndCharacteristicUuid(bleProfile.root.service.UART.UUID,bleProfile.root.service.UART.characteristic.TX.UUID,function(t){i.tx=t,i.bleDevice.getCharacteristicByServiceUuidAndCharacteristicUuid(bleProfile.root.service.UART.UUID,bleProfile.root.service.UART.characteristic.RX.UUID,function(t){i.rx=t,i.bleDevice.listenForNotificationValueFromCharacteristic(i.rx,i.rxHandler.bind(i)),e(i)})})},crcCheck:function(t){var e=t.getUint8(19);return crc8(new Uint8Array(t.buffer.slice(0,19)),!0)==e},getInc:function(){return 255<this.inc&&(this.inc=0),this.inc++},rxHandler:function(t){this.fromRobot(t.target.value)},timeoutRobot:function(t){this.pending[t]&&(clearTimeout(this.pending[t].timeout),delete this.pending[t])},fromRobot:function(t){if(this.log("RECEIVED",new Uint8Array(t.buffer)),this.crcCheck(t)){var e=t.getUint16(0),i=(t.getUint8(2),new DataView(t.buffer.slice(3,19)));this.pending[e]&&(responseCallback=this.pending[e].responseCallback,this.pending[e].timeout&&(clearTimeout(this.pending[e].timeout),delete this.pending[e]),responseCallback(i))}},toRobot:function(t,e,i,o,n){var s=this,r=new Uint8Array(20),c=this.getInc();r.set([t,e,c],0),null!=i&&r.set(i,3);var h=crc8(r.slice(0,19),!0);r.set([h],19);var a=new DataView(r.buffer);if(o){var v=a.getUint16(0);this.pending[v]={id:c,responseCallback:o,timeout:n?setTimeout(function(){s.timeoutRobot(v)},n||500):null}}this.log("SENT",new Uint8Array(a.buffer)),this.tx.writeValue(r.buffer)},listenForRobotEvent:function(t,e,i){var o=new Uint8Array(2);o.set([t,e],0);var n=new DataView(o.buffer).getUint16(0);this.pending[n]={responseCallback:i}},decodeUtf8Text:function(t){return this.utf8TextDecoder.decode(t)},encodeUtf8Text:function(t){return this.utf8TextEncoder.encode(t)},getUint4Array:function(t){var o=[];return new Uint8Array(t.buffer).forEach(function(t){var e=t>>4,i=15&t;o.push(e),o.push(i)}),o}}),Object.assign(Root.prototype,EventDispatcher.prototype),Root.identifier=bleProfile.root.service.RootIdentifier.UUID,Root.services=[bleProfile.root.service.DeviceInformation.UUID,bleProfile.root.service.UART.UUID];